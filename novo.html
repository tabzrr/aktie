<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Novo</title>
  <style>
    :root { --border:#e7e7e7; --text:#111; --muted:#666; --bg:#fff; }
    body{font-family:system-ui,Arial,sans-serif;margin:0;background:var(--bg);color:var(--text)}
    .nav{position:sticky;top:0;background:rgba(255,255,255,.92);backdrop-filter:blur(6px);border-bottom:1px solid var(--border);z-index:10}
    .nav-inner{max-width:980px;margin:0 auto;padding:10px 18px;display:flex;gap:12px;align-items:center}
    .brand{font-weight:800}
    a{text-decoration:none;color:var(--text);padding:8px 10px;border-radius:10px}
    a:hover{background:#f4f4f4}
    .wrap{max-width:980px;margin:0 auto;padding:18px}
    .card{border:1px solid var(--border);border-radius:16px;padding:16px;margin:14px 0;background:#fff}
    .muted{color:var(--muted)}
    .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
    .kpi{border:1px solid #eee;border-radius:14px;padding:12px}
    .k{font-size:12px;color:var(--muted)}
    .v{font-size:18px;font-weight:800}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .pill{display:inline-block;border:1px solid #ddd;border-radius:999px;padding:6px 10px;font-size:13px}
    .scoreBox{display:flex;align-items:baseline;gap:10px}
    .scoreNum{font-size:34px;font-weight:900;letter-spacing:-.5px}
    .tabs{display:flex;gap:8px;margin-top:10px}
    .tab{border:1px solid #ddd;border-radius:999px;padding:8px 12px;background:#fff;cursor:pointer;font-weight:700}
    .tab.active{border-color:#111}
    .small{font-size:13px}
    .list{margin:0;padding-left:18px}
  </style>
</head>
<body>
  <div class="nav">
    <div class="nav-inner">
      <div class="brand">Aktie-MVP</div>
      <a href="./index.html">Forside</a>
      <a href="./novo.html">Novo</a>
      <a href="./laering.html">Læring</a>
      <a href="./om.html">Om</a>
    </div>
  </div>

  <div class="wrap">
    <h1>Novo Nordisk (demo)</h1>
    <p class="muted" id="asof">Indlæser…</p>

    <div class="card">
      <div class="row">
        <div class="pill" id="regimePill">Regime: —</div>
        <div class="pill" id="heatPill">Momentum: —</div>
        <div class="pill" id="riskPill">Risiko: —</div>
      </div>

      <div style="margin-top:10px;">
        <div class="scoreBox">
          <div class="scoreNum" id="scoreNum">—</div>
          <div class="muted" id="scoreText">Timing-kompas (0–100)</div>
        </div>
        <p class="muted small" id="scoreWhy" style="margin-top:6px;">—</p>
      </div>
    </div>

    <div class="card">
      <h2>Pris (seneste dage)</h2>
      <p class="muted small" style="margin-top:6px;">
        Hold musen over grafen for at se dato og pris (tooltip + markør).
      </p>
      <canvas id="priceChart" height="120"></canvas>
    </div>

    <div class="card">
      <h2>Status</h2>
      <div class="grid">
        <div class="kpi"><div class="k">Lukkepris</div><div class="v" id="close">—</div></div>
        <div class="kpi"><div class="k">Dagsændring</div><div class="v" id="chg">—</div></div>
        <div class="kpi"><div class="k">Trend (MA20 / MA50 / MA200)</div><div class="v" id="trend">—</div></div>
        <div class="kpi"><div class="k">20d volatilitet (proxy)</div><div class="v" id="vol">—</div></div>
        <div class="kpi"><div class="k">52w range</div><div class="v" id="range">—</div></div>
        <div class="kpi"><div class="k">Signal (uddannelse)</div><div class="v" id="signal">—</div></div>
      </div>
    </div>

    <div class="card">
      <h2>“Hvis du vil købe / sælge” (scenarier)</h2>
      <div class="tabs">
        <button class="tab active" id="tabBuy">Hvis du vil købe</button>
        <button class="tab" id="tabSell">Hvis du vil sælge</button>
      </div>
      <div class="card" style="margin-top:12px;">
        <p id="scenarioText" class="muted" style="margin:0;">—</p>
      </div>
      <p class="muted small" style="margin-top:10px;">
        Disclaimer: Ikke investeringsrådgivning. Kun information/uddannelse.
      </p>
    </div>

    <div class="card">
      <h2>Forklaring</h2>
      <ul id="why" class="muted list"></ul>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    function fmt(n){ return (typeof n==="number") ? n.toFixed(2) : "—"; }

    // --- Simple, gennemsigtig “timing-kompas” logik ---
    // Score 0–100 baseret på: trend + “heat” + risiko
    // (Det er ikke “sandhed”, bare en enkel proxy der kan forklares til brugeren.)
    function clamp(x, a, b){ return Math.max(a, Math.min(b, x)); }

    function compute(d){
      // Trend: pris over/under MA50/MA200
      let trendScore = 50;
      if (d.close > d.ma50) trendScore += 15; else trendScore -= 15;
      if (d.close > d.ma200) trendScore += 20; else trendScore -= 20;
      trendScore = clamp(trendScore, 0, 100);

      // “Heat” (overophedning) proxy: afstand til MA50 (jo længere over, jo mere strukket)
      // Hvis vi ikke har RSI endnu, er dette en fin MVP-proxy.
      const dist = (d.ma50 && d.ma50 !== 0) ? ((d.close - d.ma50) / d.ma50) : 0; // fx 0.03 = 3%
      // dist omkring 0–3% = ok, >6% = mere strukket
      let heatScore = 70 - (Math.abs(dist) * 800); // grov mapping
      heatScore = clamp(heatScore, 0, 100);

      // Risiko: vol20 (lavere vol = “nemmere timing”)
      // vol20 i %: 1-2 = lav, 3-4 = middel, 5+ = høj (meget groft)
      let riskScore = 80 - (d.vol20 * 10);
      riskScore = clamp(riskScore, 0, 100);

      const score = Math.round((trendScore * 0.5) + (heatScore * 0.3) + (riskScore * 0.2));

      // Labels til UI
      const regime = (d.close > d.ma200) ? "Trend op (lang)" : (d.close > d.ma50 ? "Trend op (kort)" : "Neutral/svag");
      const heat = (Math.abs(dist) >= 0.06) ? "Overophedet (strukket)" : (Math.abs(dist) >= 0.03 ? "Let strukket" : "Neutral");
      const risk = (d.vol20 >= 5) ? "Høj" : (d.vol20 >= 3 ? "Middel" : "Lav");

      // Forklaring i én linje
      const why = `Trend=${regime}. Momentum=${heat}. Risiko=${risk}. (Score er en simpel proxy baseret på MA/afstand/volatilitet.)`;

      return { score, regime, heat, risk, dist, why, trendScore, heatScore, riskScore };
    }

    function makeSignal(d){
      if (d.close > d.ma200) return "Trend op (stærk)";
      if (d.close > d.ma50) return "Trend op (moderat)";
      if (d.close < d.ma50) return "Svag/neutral";
      return "Neutral";
    }

    function makeWhyBullets(d, meta){
      const items = [];
      items.push(`Pris vs MA50: ${d.close > d.ma50 ? "over" : "under"} (trend-proxy)`);
      items.push(`Pris vs MA200: ${d.close > d.ma200 ? "over" : "under"} (lang trend)`);
      items.push(`Volatilitet 20d: ca. ${fmt(d.vol20)}% (risk-proxy)`);
      if (d.ma50) items.push(`Afstand til MA50: ca. ${(meta.dist*100).toFixed(1)}% (over/under = “stræk”)`);
      items.push(`Timing-score (0–100): ${meta.score} (gennemsnit af trend/heat/risiko)`);
      return items;
    }

    function scenarioBuy(meta){
      if (meta.regime.includes("Trend op")) {
        if (meta.heat.includes("Overophedet")) {
          return "I en optrend men overophedet: Mange venter typisk på et pullback (fx nær MA20/MA50) i stedet for at købe ‘på toppen’. Overvej mindre position og tydelig plan.";
        }
        return "I en optrend: Mange køber typisk på pullbacks eller ved brud over tydelige niveauer. Fokus er ofte på risikostyring (stops/position size) frem for perfekt entry.";
      }
      return "Neutral/svag trend: Mange afventer ofte klarere retning. Hvis man køber, sker det typisk med mindre størrelse og tydelig ‘invalidation’ (hvornår tager man fejl?).";
    }

    function scenarioSell(meta){
      if (meta.regime.includes("Trend op")) {
        return "I en optrend: Mange sælger typisk enten gradvist (take profit) eller bruger trailing stop under struktur, fremfor at forsøge at time den præcise top.";
      }
      return "Neutral/svag trend: Mange sælger typisk ind i styrke/range-toppe eller reducerer risiko, hvis prisen bryder ned under vigtige niveauer (fx MA200).";
    }

    // --- Chart: “crosshair-ish” hover (tooltip + lodret markør) ---
    const vLinePlugin = {
      id: 'vLine',
      afterDraw(chart) {
        const tooltip = chart.tooltip;
        if (tooltip && tooltip.getActiveElements && tooltip.getActiveElements().length) {
          const ctx = chart.ctx;
          const x = tooltip.getActiveElements()[0].element.x;
          const topY = chart.scales.y.top;
          const bottomY = chart.scales.y.bottom;

          ctx.save();
          ctx.beginPath();
          ctx.moveTo(x, topY);
          ctx.lineTo(x, bottomY);
          ctx.lineWidth = 1;
          ctx.strokeStyle = 'rgba(0,0,0,0.25)';
          ctx.stroke();
          ctx.restore();
        }
      }
    };

    function renderScenario(active, meta){
      const buyBtn = document.getElementById("tabBuy");
      const sellBtn = document.getElementById("tabSell");
      buyBtn.classList.toggle("active", active === "buy");
      sellBtn.classList.toggle("active", active === "sell");
      document.getElementById("scenarioText").textContent =
        (active === "buy") ? scenarioBuy(meta) : scenarioSell(meta);
    }

    window.addEventListener("DOMContentLoaded", () => {
      const url = "./data/novo.json?v=" + Date.now(); // cache-buster
      fetch(url)
        .then(r => {
          if (!r.ok) throw new Error("HTTP " + r.status);
          return r.json();
        })
        .then(d => {
          // Header
          document.getElementById("asof").textContent = `Data pr. ${d.asOf} (ticker: ${d.ticker})`;

          // Status
          document.getElementById("close").textContent = `${fmt(d.close)} DKK`;
          document.getElementById("chg").textContent   = `${fmt(d.changePct)}%`;
          document.getElementById("trend").textContent = `${fmt(d.ma20)} / ${fmt(d.ma50)} / ${fmt(d.ma200)}`;
          document.getElementById("vol").textContent   = `${fmt(d.vol20)}%`;
          document.getElementById("range").textContent = `${fmt(d.low52w)} – ${fmt(d.high52w)}`;
          document.getElementById("signal").textContent = makeSignal(d);

          // Kompas
          const meta = compute(d);
          document.getElementById("scoreNum").textContent = meta.score;
          document.getElementById("scoreWhy").textContent = meta.why;
          document.getElementById("regimePill").textContent = `Regime: ${meta.regime}`;
          document.getElementById("heatPill").textContent   = `Momentum: ${meta.heat}`;
          document.getElementById("riskPill").textContent   = `Risiko: ${meta.risk}`;

          // Scenarier tabs
          renderScenario("buy", meta);
          document.getElementById("tabBuy").onclick = () => renderScenario("buy", meta);
          document.getElementById("tabSell").onclick = () => renderScenario("sell", meta);

          // Forklaring bullets
          const ul = document.getElementById("why");
          ul.innerHTML = "";
          makeWhyBullets(d, meta).forEach(x => {
            const li = document.createElement("li");
            li.textContent = x;
            ul.appendChild(li);
          });

          // Chart
          if (Array.isArray(d.history) && d.history.length > 1) {
            const labels = d.history.map(x => x.date);
            const prices = d.history.map(x => x.close);
            const canvas = document.getElementById("priceChart");

            if (window.__novoChart) window.__novoChart.destroy();
            window.__novoChart = new Chart(canvas, {
              type: "line",
              data: {
                labels,
                datasets: [{
                  data: prices,
                  tension: 0.25,
                  pointRadius: 0,
                  pointHoverRadius: 3
                }]
              },
              options: {
                responsive: true,
                plugins: {
                  legend: { display: false },
                  tooltip: {
                    enabled: true,
                    displayColors: false,
                    callbacks: {
                      title: (items) => items?.[0]?.label ? `Dato: ${items[0].label}` : "",
                      label: (item) => `Pris: ${fmt(item.parsed.y)} DKK`
                    }
                  }
                },
                interaction: {
                  mode: "index",
                  intersect: false
                },
                scales: {
                  x: { ticks: { maxTicksLimit: 6 } },
                  y: { ticks: { maxTicksLimit: 6 } }
                }
              },
              plugins: [vLinePlugin]
            });
          }
        })
        .catch(err => {
          document.getElementById("asof").textContent = "Fejl: " + (err?.message || err);
        });
    });
  </script>
</body>
</html>
