<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Aktie</title>
  <style>
    :root { --border:#e7e7e7; --text:#111; --muted:#666; --bg:#fff; }
    body{font-family:system-ui,Arial,sans-serif;margin:0;background:var(--bg);color:var(--text)}
    .nav{position:sticky;top:0;background:rgba(255,255,255,.92);backdrop-filter:blur(6px);border-bottom:1px solid var(--border);z-index:10}
    .nav-inner{max-width:980px;margin:0 auto;padding:10px 18px;display:flex;gap:12px;align-items:center}
    .brand{font-weight:800}
    a{text-decoration:none;color:var(--text);padding:8px 10px;border-radius:10px}
    a:hover{background:#f4f4f4}

    /* Aktier dropdown */
    .drop{position:relative;display:inline-block}
    .drop > .dropbtn{border:0;background:transparent;color:var(--text);padding:8px 10px;border-radius:10px;cursor:pointer;font:inherit}
    .drop > .dropbtn:hover{background:#f4f4f4}
    .menu{display:none;position:absolute;top:40px;left:0;min-width:200px;background:#fff;border:1px solid var(--border);border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.08);padding:6px;z-index:20}
    .menu a{display:block;padding:10px 10px;border-radius:10px}
    .menu a:hover{background:#f4f4f4}
    .drop:hover .menu{display:block}

    .wrap{max-width:980px;margin:0 auto;padding:18px}
    .card{border:1px solid var(--border);border-radius:16px;padding:16px;margin:14px 0;background:#fff}
    .muted{color:var(--muted)}
    .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
    .kpi{border:1px solid #eee;border-radius:14px;padding:12px}
    .k{font-size:12px;color:var(--muted)}
    .v{font-size:18px;font-weight:800}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .pill{display:inline-block;border:1px solid #ddd;border-radius:999px;padding:6px 10px;font-size:13px}
    .scoreBox{display:flex;align-items:baseline;gap:10px}
    .scoreNum{font-size:34px;font-weight:900;letter-spacing:-.5px}
    .tabs{display:flex;gap:8px;margin-top:10px}
    .tab{border:1px solid #ddd;border-radius:999px;padding:8px 12px;background:#fff;cursor:pointer;font-weight:700}
    .tab.active{border-color:#111}
    .small{font-size:13px}
    .list{margin:0;padding-left:18px}
    button.btn{border:1px solid #ddd;border-radius:12px;padding:10px 12px;background:#fff;cursor:pointer;font-weight:800}
    button.btn:hover{background:#f6f6f6}
    textarea{width:100%;min-height:120px;border:1px solid #e7e7e7;border-radius:14px;padding:12px;font-family:inherit}

    /* timeframe + slider */
    .tfbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-top:10px}
    .tfbtn{border:1px solid #ddd;border-radius:999px;padding:8px 12px;background:#fff;cursor:pointer;font-weight:800}
    .tfbtn:hover{background:#f6f6f6}
    .tfbtn.active{border-color:#111}
    .sliderWrap{margin-top:12px;border-top:1px solid #eee;padding-top:12px}
    input[type="range"]{width:100%}
    .sliderMeta{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}
  </style>
</head>
<body>
  <div class="nav">
    <div class="nav-inner">
      <div class="brand">Aktie-MVP</div>
      <a href="./index.html">Forside</a>

      <div class="drop">
        <button class="dropbtn">Aktier ▾</button>
        <div class="menu" id="stocksMenu"></div>
      </div>

      <a href="./laering.html">Læring</a>
      <a href="./om.html">Om</a>
    </div>
  </div>

  <div class="wrap">
    <h1 id="title">Aktie</h1>
    <p class="muted" id="asof">Indlæser…</p>

    <div class="card">
      <div class="row">
        <div class="pill" id="regimePill">Regime: —</div>
        <div class="pill" id="heatPill">Momentum: —</div>
        <div class="pill" id="riskPill">Risiko: —</div>
      </div>

      <div style="margin-top:10px;">
        <div class="scoreBox">
          <div class="scoreNum" id="scoreNum">—</div>
          <div class="muted">Timing-kompas (0–100)</div>
        </div>
        <p class="muted small" id="scoreWhy" style="margin-top:6px;">—</p>
      </div>
    </div>

    <div class="card">
      <h2>Pris (historik)</h2>
      <p class="muted small" style="margin-top:6px;">
        Hold musen over grafen for at se dato og pris (tooltip + crosshair).
      </p>

      <div class="tfbar">
        <button class="tfbtn" data-tf="1M">1M</button>
        <button class="tfbtn active" data-tf="3M">3M</button>
        <button class="tfbtn" data-tf="6M">6M</button>
        <button class="tfbtn" data-tf="1Y">1Y</button>
        <button class="tfbtn" data-tf="MAX">MAX</button>
        <span class="muted small" id="tfInfo">—</span>
      </div>

      <canvas id="priceChart" height="120"></canvas>

      <div class="sliderWrap">
        <div class="sliderMeta">
          <div class="muted small"><b>Spol tilbage:</b> vælg hvor vinduet slutter</div>
          <div class="muted small" id="sliderLabel">—</div>
        </div>
        <input id="windowSlider" type="range" min="0" max="0" value="0" step="1" />
      </div>
    </div>

    <div class="card">
      <h2>Status</h2>
      <div class="grid">
        <div class="kpi"><div class="k">Lukkepris</div><div class="v" id="close">—</div></div>
        <div class="kpi"><div class="k">Dagsændring</div><div class="v" id="chg">—</div></div>
        <div class="kpi"><div class="k">Trend (MA20 / MA50 / MA200)</div><div class="v" id="trend">—</div></div>
        <div class="kpi"><div class="k">20d volatilitet (proxy)</div><div class="v" id="vol">—</div></div>
        <div class="kpi"><div class="k">52w range</div><div class="v" id="range">—</div></div>
        <div class="kpi"><div class="k">Signal (uddannelse)</div><div class="v" id="signal">—</div></div>
      </div>
    </div>

    <div class="card">
      <h2>“Hvis du vil købe / sælge” (scenarier)</h2>
      <div class="tabs">
        <button class="tab active" id="tabBuy">Hvis du vil købe</button>
        <button class="tab" id="tabSell">Hvis du vil sælge</button>
      </div>
      <div class="card" style="margin-top:12px;">
        <p id="scenarioText" class="muted" style="margin:0;">—</p>
      </div>
      <p class="muted small" style="margin-top:10px;">
        Disclaimer: Ikke investeringsrådgivning. Kun information/uddannelse.
      </p>
    </div>

    <div class="card">
      <h2>Video-script (60 sek)</h2>
      <p class="muted small">Klik og få et kort manus du kan læse op i en video.</p>
      <div class="row">
        <button class="btn" id="makeScriptBtn">Generér script</button>
      </div>
      <div style="margin-top:10px;">
        <textarea id="scriptBox" placeholder="Tryk 'Generér script'…"></textarea>
      </div>
    </div>

    <div class="card">
      <h2>Forklaring</h2>
      <ul id="why" class="muted list"></ul>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    // --- shared: stocks list in localStorage ---
    const LS_KEY = "stocks_v1";
    const DEFAULT_STOCKS = [
      { id: "novo",   name: "Novo Nordisk" },
      { id: "vestas", name: "Vestas" },
      { id: "dsv",    name: "DSV" },
      { id: "genmab", name: "Genmab" }
    ];

    function cleanId(s){ return String(s || "").trim().toLowerCase(); }
    function isValidId(id){ return /^[a-z0-9_-]+$/.test(id); }

    function loadStocks(){
      try {
        const raw = localStorage.getItem(LS_KEY);
        if (!raw) return DEFAULT_STOCKS.slice();
        const parsed = JSON.parse(raw);
        if (!Array.isArray(parsed) || parsed.length === 0) return DEFAULT_STOCKS.slice();
        return parsed
          .map(x => ({ id: cleanId(x.id), name: String(x.name || "").trim() || cleanId(x.id) }))
          .filter(x => x.id && isValidId(x.id));
      } catch {
        return DEFAULT_STOCKS.slice();
      }
    }

    function renderMenu(stocks, currentId){
      const menu = document.getElementById("stocksMenu");
      menu.innerHTML = "";
      stocks.forEach(s => {
        const a = document.createElement("a");
        a.href = `./stock.html?t=${encodeURIComponent(s.id)}`;
        a.textContent = (s.id === currentId) ? `✓ ${s.name}` : s.name;
        menu.appendChild(a);
      });
      const sep = document.createElement("div");
      sep.style.height = "1px";
      sep.style.background = "#eee";
      sep.style.margin = "6px";
      menu.appendChild(sep);

      const add = document.createElement("a");
      add.href = "./index.html#aktier";
      add.textContent = "Tilføj flere aktier…";
      menu.appendChild(add);
    }

    // --- app logic ---
    function fmt(n){ return (typeof n==="number") ? n.toFixed(2) : "—"; }
    function clamp(x, a, b){ return Math.max(a, Math.min(b, x)); }

    function compute(d){
      let trendScore = 50;
      if (d.close > d.ma50) trendScore += 15; else trendScore -= 15;
      if (d.close > d.ma200) trendScore += 20; else trendScore -= 20;
      trendScore = clamp(trendScore, 0, 100);

      const dist = (d.ma50 && d.ma50 !== 0) ? ((d.close - d.ma50) / d.ma50) : 0;
      let heatScore = 70 - (Math.abs(dist) * 800);
      heatScore = clamp(heatScore, 0, 100);

      let riskScore = 80 - (d.vol20 * 10);
      riskScore = clamp(riskScore, 0, 100);

      const score = Math.round((trendScore * 0.5) + (heatScore * 0.3) + (riskScore * 0.2));

      const regime = (d.close > d.ma200) ? "Trend op (lang)" : (d.close > d.ma50 ? "Trend op (kort)" : "Neutral/svag");
      const heat = (Math.abs(dist) >= 0.06) ? "Overophedet (strukket)" : (Math.abs(dist) >= 0.03 ? "Let strukket" : "Neutral");
      const risk = (d.vol20 >= 5) ? "Høj" : (d.vol20 >= 3 ? "Middel" : "Lav");

      const why = `Trend=${regime}. Momentum=${heat}. Risiko=${risk}. (Score er en simpel proxy baseret på MA/afstand/volatilitet.)`;
      return { score, regime, heat, risk, dist, why };
    }

    function makeSignal(d){
      if (d.close > d.ma200) return "Trend op (stærk)";
      if (d.close > d.ma50) return "Trend op (moderat)";
      if (d.close < d.ma50) return "Svag/neutral";
      return "Neutral";
    }

    function makeWhyBullets(d, meta){
      const items = [];
      items.push(`Pris vs MA50: ${d.close > d.ma50 ? "over" : "under"} (trend-proxy)`);
      items.push(`Pris vs MA200: ${d.close > d.ma200 ? "over" : "under"} (lang trend)`);
      items.push(`Volatilitet 20d: ca. ${fmt(d.vol20)}% (risk-proxy)`);
      if (d.ma50) items.push(`Afstand til MA50: ca. ${(meta.dist*100).toFixed(1)}% (stræk-proxy)`);
      items.push(`Timing-score (0–100): ${meta.score}`);
      return items;
    }

    function scenarioBuy(meta){
      if (meta.regime.includes("Trend op")) {
        if (meta.heat.includes("Overophedet")) {
          return "Optrend men overophedet: Mange venter typisk på pullback (fx nær MA20/MA50) i stedet for at købe ‘på toppen’. Overvej mindre størrelse og klar plan.";
        }
        return "Optrend: Mange køber typisk på pullbacks eller ved brud over tydelige niveauer. Fokus er ofte risikostyring (stops/position size) fremfor perfekt entry.";
      }
      return "Neutral/svag trend: Mange afventer ofte klarere retning. Hvis man køber, sker det typisk med mindre størrelse og tydelig ‘invalidation’ (hvornår tager man fejl?).";
    }

    function scenarioSell(meta){
      if (meta.regime.includes("Trend op")) {
        return "Optrend: Mange sælger typisk gradvist (take profit) eller bruger trailing stop under struktur fremfor at forsøge at time den præcise top.";
      }
      return "Neutral/svag trend: Mange sælger typisk ind i styrke/range-toppe eller reducerer risiko, hvis prisen bryder ned under vigtige niveauer (fx MA200).";
    }

    const crosshairPlugin = {
      id: 'crosshair',
      afterDraw(chart) {
        const tooltip = chart.tooltip;
        if (!tooltip || !tooltip.getActiveElements || !tooltip.getActiveElements().length) return;
        const ctx = chart.ctx;
        const el = tooltip.getActiveElements()[0].element;
        const x = el.x;
        const y = el.y;
        const yScale = chart.scales.y;
        const xScale = chart.scales.x;

        ctx.save();
        ctx.strokeStyle = 'rgba(0,0,0,0.22)';
        ctx.lineWidth = 1;

        ctx.beginPath(); ctx.moveTo(x, yScale.top); ctx.lineTo(x, yScale.bottom); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(xScale.left, y); ctx.lineTo(xScale.right, y); ctx.stroke();

        ctx.restore();
      }
    };

    function renderScenario(active, meta){
      const buyBtn = document.getElementById("tabBuy");
      const sellBtn = document.getElementById("tabSell");
      buyBtn.classList.toggle("active", active === "buy");
      sellBtn.classList.toggle("active", active === "sell");
      document.getElementById("scenarioText").textContent =
        (active === "buy") ? scenarioBuy(meta) : scenarioSell(meta);
    }

    function getParam(name){
      const u = new URL(window.location.href);
      return u.searchParams.get(name);
    }

    function makeScript(d, meta){
      const close = fmt(d.close);
      const chg = fmt(d.changePct);
      const vol = fmt(d.vol20);
      return [
        `Hej — hurtigt overblik på ${d.ticker} (pr. ${d.asOf}).`,
        `Lukkepris er ${close} DKK, og dagsændring er ${chg}%.`,
        `Regime: ${meta.regime}. Momentum: ${meta.heat}. Risiko: ${meta.risk} (vol ca. ${vol}%).`,
        ``,
        `Hvis du vil købe: ${scenarioBuy(meta)}`,
        ``,
        `Hvis du vil sælge: ${scenarioSell(meta)}`,
        ``,
        `Husk: Det her er ikke rådgivning, kun uddannelse baseret på simple indikator-proxies.`
      ].join("\n");
    }

    // --- timeframe + slider logic ---
    const TF_POINTS = { "1M": 21, "3M": 63, "6M": 126, "1Y": 252, "MAX": 999999 };

    let fullHistory = [];
    let tf = "3M";
    let endIndex = 0; // index i fullHistory som vinduet slutter på
    let chart = null;

    function sliceWindow(){
      const n = fullHistory.length;
      if (n === 0) return { labels: [], prices: [], from: 0, to: 0 };

      const maxPoints = TF_POINTS[tf] || 63;
      const to = clamp(endIndex, 0, n - 1);
      const from = Math.max(0, to - maxPoints + 1);

      const window = fullHistory.slice(from, to + 1);
      return {
        labels: window.map(x => x.date),
        prices: window.map(x => x.close),
        from,
        to
      };
    }

    function updateTfButtons(){
      document.querySelectorAll(".tfbtn").forEach(b => {
        b.classList.toggle("active", b.getAttribute("data-tf") === tf);
      });
    }

    function updateSliderUI(){
      const slider = document.getElementById("windowSlider");
      const label = document.getElementById("sliderLabel");

      if (!fullHistory.length){
        slider.min = 0; slider.max = 0; slider.value = 0;
        label.textContent = "—";
        return;
      }

      slider.min = 0;
      slider.max = String(fullHistory.length - 1);
      slider.value = String(endIndex);

      const item = fullHistory[endIndex];
      label.textContent = item ? `Slutdato: ${item.date} (pris: ${fmt(item.close)} DKK)` : "—";
    }

    function updateTfInfo(from, to){
      const el = document.getElementById("tfInfo");
      if (!fullHistory.length) { el.textContent = "—"; return; }
      const a = fullHistory[from]?.date || "—";
      const b = fullHistory[to]?.date || "—";
      el.textContent = `Viser: ${a} → ${b}`;
    }

    function renderChart(){
      const { labels, prices, from, to } = sliceWindow();
      updateTfInfo(from, to);
      updateSliderUI();

      const canvas = document.getElementById("priceChart");

      if (!chart){
        chart = new Chart(canvas, {
          type: "line",
          data: { labels, datasets: [{ data: prices, tension: 0.25, pointRadius: 0, pointHoverRadius: 3 }] },
          options: {
            responsive: true,
            plugins: {
              legend: { display: false },
              tooltip: {
                enabled: true,
                displayColors: false,
                callbacks: {
                  title: (items) => items?.[0]?.label ? `Dato: ${items[0].label}` : "",
                  label: (item) => `Pris: ${fmt(item.parsed.y)} DKK`
                }
              }
            },
            interaction: { mode: "index", intersect: false },
            scales: {
              x: { ticks: { maxTicksLimit: 6 } },
              y: { ticks: { maxTicksLimit: 6 } }
            }
          },
          plugins: [crosshairPlugin]
        });
        return;
      }

      chart.data.labels = labels;
      chart.data.datasets[0].data = prices;
      chart.update();
    }

    function setTimeframe(newTf){
      tf = newTf;
      updateTfButtons();
      // hvis user vælger MAX, giv fuld udsigt; ellers behold samme endIndex
      renderChart();
    }

    window.addEventListener("DOMContentLoaded", () => {
      const stocks = loadStocks();
      const fallback = (stocks[0] && stocks[0].id) ? stocks[0].id : "novo";
      const t = cleanId(getParam("t") || fallback);

      renderMenu(stocks, t);

      const url = `./data/${t}.json?v=` + Date.now();
      fetch(url)
        .then(r => { if (!r.ok) throw new Error("HTTP " + r.status); return r.json(); })
        .then(d => {
          document.getElementById("title").textContent = (d.name ? d.name : `${d.ticker} (demo)`);
          document.title = d.name ? d.name : d.ticker;

          document.getElementById("asof").textContent = `Data pr. ${d.asOf} (ticker: ${d.ticker})`;

          document.getElementById("close").textContent = `${fmt(d.close)} DKK`;
          document.getElementById("chg").textContent   = `${fmt(d.changePct)}%`;
          document.getElementById("trend").textContent = `${fmt(d.ma20)} / ${fmt(d.ma50)} / ${fmt(d.ma200)}`;
          document.getElementById("vol").textContent   = `${fmt(d.vol20)}%`;
          document.getElementById("range").textContent = `${fmt(d.low52w)} – ${fmt(d.high52w)}`;
          document.getElementById("signal").textContent = makeSignal(d);

          const meta = compute(d);
          document.getElementById("scoreNum").textContent = meta.score;
          document.getElementById("scoreWhy").textContent = meta.why;
          document.getElementById("regimePill").textContent = `Regime: ${meta.regime}`;
          document.getElementById("heatPill").textContent   = `Momentum: ${meta.heat}`;
          document.getElementById("riskPill").textContent   = `Risiko: ${meta.risk}`;

          renderScenario("buy", meta);
          document.getElementById("tabBuy").onclick = () => renderScenario("buy", meta);
          document.getElementById("tabSell").onclick = () => renderScenario("sell", meta);

          document.getElementById("makeScriptBtn").onclick = () => {
            document.getElementById("scriptBox").value = makeScript(d, meta);
          };

          const ul = document.getElementById("why");
          ul.innerHTML = "";
          makeWhyBullets(d, meta).forEach(x => {
            const li = document.createElement("li");
            li.textContent = x;
            ul.appendChild(li);
          });

          // timeframe + slider init
          fullHistory = Array.isArray(d.history) ? d.history.slice() : [];
          if (fullHistory.length < 2){
            document.getElementById("tfInfo").textContent = "Tilføj flere punkter i history[] for timeframe/slider.";
            return;
          }

          endIndex = fullHistory.length - 1;
          updateTfButtons();

          document.querySelectorAll(".tfbtn").forEach(b => {
            b.addEventListener("click", () => setTimeframe(b.getAttribute("data-tf")));
          });

          const slider = document.getElementById("windowSlider");
          slider.addEventListener("input", () => {
            endIndex = Number(slider.value || 0);
            renderChart();
          });

          renderChart();
        })
        .catch(err => {
          document.getElementById("asof").textContent =
            `Fejl: kunne ikke hente datafilen ./data/${t}.json ( ${err.message} )`;
        });
    });
  </script>
</body>
</html>
