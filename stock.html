<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Aktie</title>
  <style>
    :root { --border:#e7e7e7; --text:#111; --muted:#666; --bg:#fff; }
    body{font-family:system-ui,Arial,sans-serif;margin:0;background:var(--bg);color:var(--text)}
    .nav{position:sticky;top:0;background:rgba(255,255,255,.92);backdrop-filter:blur(6px);border-bottom:1px solid var(--border);z-index:10}
    .nav-inner{max-width:980px;margin:0 auto;padding:10px 18px;display:flex;gap:12px;align-items:center}
    .brand{font-weight:800}
    a{text-decoration:none;color:var(--text);padding:8px 10px;border-radius:10px}
    a:hover{background:#f4f4f4}
    .spacer{flex:1}
    .pill{display:inline-block;border:1px solid #ddd;border-radius:999px;padding:6px 10px;font-size:13px;color:var(--muted)}
    .drop{position:relative;display:inline-block}
    .dropbtn{border:0;background:transparent;color:var(--text);padding:8px 10px;border-radius:10px;cursor:pointer;font:inherit}
    .dropbtn:hover{background:#f4f4f4}
    .menu{display:none;position:absolute;top:40px;left:0;min-width:240px;background:#fff;border:1px solid var(--border);border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.08);padding:6px;z-index:20}
    .menu a{display:block;padding:10px 10px;border-radius:10px}
    .menu a:hover{background:#f4f4f4}
    .drop:hover .menu{display:block}

    .wrap{max-width:980px;margin:0 auto;padding:18px}
    .card{border:1px solid var(--border);border-radius:16px;padding:16px;margin:14px 0;background:#fff}
    .muted{color:var(--muted)}
    .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
    .kpi{border:1px solid #eee;border-radius:14px;padding:12px}
    .k{font-size:12px;color:var(--muted)}
    .v{font-size:18px;font-weight:800;margin-top:6px}
    .badges{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .badge{border:1px solid #e5e5e5;border-radius:999px;padding:6px 10px;font-size:13px;background:#fafafa}
    canvas{width:100%;height:340px;border:1px solid #eee;border-radius:14px}
    .note{font-size:13px;color:var(--muted);margin-top:8px}
  </style>
</head>
<body>
  <div class="nav">
    <div class="nav-inner">
      <div class="brand">Aktie-MVP</div>
      <a href="./index.html">Forside</a>

      <div class="drop">
        <button class="dropbtn">Aktier ▾</button>
        <div class="menu" id="stocksMenu"></div>
      </div>

      <a href="./laering.html">Læring</a>
      <a href="./om.html">Om</a>
      <div class="spacer"></div>
      <span class="pill" id="updatedPill">Sidst opdateret: —</span>
    </div>
  </div>

  <div class="wrap">
    <h1 id="title">Aktie (demo)</h1>
    <p class="muted" id="asof">Indlæser…</p>
    <p class="muted" id="err" style="display:none"></p>

    <div class="card">
      <div class="badges">
        <span class="badge" id="bRegime">Regime: —</span>
        <span class="badge" id="bMomentum">Momentum: —</span>
        <span class="badge" id="bRisk">Risiko: —</span>
      </div>

      <div style="margin-top:12px;display:flex;gap:12px;align-items:baseline;flex-wrap:wrap">
        <div style="font-size:44px;font-weight:900;line-height:1" id="score">—</div>
        <div>
          <div style="font-weight:900">Timing-kompas (0–100)</div>
          <div class="note" id="scoreNote">Score er en simpel proxy baseret på MA/afstand/volatilitet.</div>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>Pris (seneste periode)</h2>
      <p class="note">Hold musen over grafen for at se dato og pris (tooltip + crosshair).</p>
      <canvas id="chart" aria-label="Prisgraf"></canvas>
    </div>

    <div class="card">
      <h2>Status</h2>
      <div class="grid">
        <div class="kpi"><div class="k">Lukkepris</div><div class="v" id="close">—</div></div>
        <div class="kpi"><div class="k">Dagsændring</div><div class="v" id="chg">—</div></div>
        <div class="kpi"><div class="k">Trend (MA20 / MA50 / MA200)</div><div class="v" id="trend">—</div></div>
        <div class="kpi"><div class="k">20d volatilitet (proxy)</div><div class="v" id="vol">—</div></div>
        <div class="kpi"><div class="k">52w range</div><div class="v" id="range">—</div></div>
        <div class="kpi"><div class="k">Signal (uddannelse)</div><div class="v" id="signal">—</div></div>
      </div>
    </div>

    <div class="card">
      <h2>Forklaring</h2>
      <ul id="why" class="muted"></ul>
      <p class="muted" style="font-size:13px;margin-top:12px;">
        Disclaimer: Ikke investeringsrådgivning. Kun information/uddannelse.
      </p>
    </div>
  </div>

  <script>
    // -------- helpers --------
    const updatedPill = document.getElementById("updatedPill");
    updatedPill.textContent = "Sidst opdateret: " + new Date().toISOString().slice(0,19).replace("T"," ");

    const q = new URLSearchParams(location.search);
    const id = (q.get("t") || "novo").trim().toLowerCase();

    const STOCKS_FILE = "./data/stocks.json?v=" + Date.now();
    const DATA_FILE = `./data/${encodeURIComponent(id)}.json?v=` + Date.now();

    const fmt = (n) => (typeof n === "number" && isFinite(n)) ? n.toFixed(1) : "—";
    const fmtPct = (n) => (typeof n === "number" && isFinite(n)) ? (n.toFixed(1) + "%") : "—";

    function setErr(msg){
      const el = document.getElementById("err");
      el.style.display = "block";
      el.textContent = msg;
    }

    function pickRegime(d){
      // Simple regime proxy based on MAs (demo)
      if(!(typeof d.close === "number" && typeof d.ma200 === "number")) return "—";
      if(d.close > d.ma200) return "Trend op (lang)";
      return "Under MA200";
    }
    function pickMomentum(d){
      if(!(typeof d.close === "number" && typeof d.ma20 === "number")) return "—";
      const dist = (d.close - d.ma20) / d.ma20;
      if(dist > 0.03) return "Strukket op";
      if(dist < -0.03) return "Strukket ned";
      return "Neutral";
    }
    function pickRisk(d){
      if(!(typeof d.vol20 === "number" && isFinite(d.vol20))) return "—";
      if(d.vol20 < 1.5) return "Lav";
      if(d.vol20 < 3.0) return "Middel";
      return "Høj";
    }

    function computeScore(d){
      // 0..100 demo-score: trend + momentum + risk penalty
      let score = 50;

      // trend factor
      if(typeof d.close === "number" && typeof d.ma200 === "number" && d.ma200 > 0){
        const rel = (d.close - d.ma200) / d.ma200; // ~ -0.2..0.2
        score += Math.max(-20, Math.min(20, rel * 80));
      }
      // momentum factor (distance to MA20)
      if(typeof d.close === "number" && typeof d.ma20 === "number" && d.ma20 > 0){
        const rel = (d.close - d.ma20) / d.ma20;
        score += Math.max(-15, Math.min(15, rel * 120));
      }
      // risk penalty
      if(typeof d.vol20 === "number"){
        score -= Math.max(0, Math.min(15, (d.vol20 - 1.5) * 5));
      }

      score = Math.round(Math.max(0, Math.min(100, score)));
      return score;
    }

    function makeSignal(d){
      const reg = pickRegime(d);
      const mom = pickMomentum(d);
      const risk = pickRisk(d);

      if(reg.includes("Trend op") && mom === "Neutral" && risk !== "Høj") return "OK timing (trend op, ikke strukket)";
      if(mom.includes("Strukket") && risk !== "Lav") return "Pas på (strukket + risiko)";
      if(reg === "Under MA200") return "Defensiv bias (under MA200)";
      return "Neutral";
    }

    function makeWhy(d){
      const out = [];
      if(typeof d.ma20 === "number" && typeof d.ma50 === "number" && typeof d.ma200 === "number"){
        out.push("Trend vurderes via MA20/MA50/MA200 (simpel proxy).");
      }
      if(typeof d.vol20 === "number"){
        out.push("Risiko-proxy: 20d volatilitet (jo højere, jo mere udsving).");
      }
      if(typeof d.low52w === "number" && typeof d.high52w === "number"){
        out.push("52w range giver kontekst: hvor tæt er kursen på bund/top.");
      }
      out.push("Timing-kompas er en *demo*-score (ikke et signal du skal følge blindt).");
      return out;
    }

    // -------- chart (simple canvas + crosshair) --------
    function drawChart(history){
      const canvas = document.getElementById("chart");
      const ctx = canvas.getContext("2d");

      // hi-dpi
      const rect = canvas.getBoundingClientRect();
      const dpr = window.devicePixelRatio || 1;
      canvas.width = Math.round(rect.width * dpr);
      canvas.height = Math.round(rect.height * dpr);
      ctx.scale(dpr, dpr);

      const W = rect.width, H = rect.height;
      const pad = 18;

      const xs = history.map((_, i) => i);
      const ys = history.map(p => p.close);

      const minY = Math.min(...ys);
      const maxY = Math.max(...ys);
      const ySpan = (maxY - minY) || 1;

      function xToPx(i){
        const t = i / Math.max(1, xs.length - 1);
        return pad + t * (W - pad*2);
      }
      function yToPx(y){
        const t = (y - minY) / ySpan;
        return (H - pad) - t * (H - pad*2);
      }

      function clear(){
        ctx.clearRect(0,0,W,H);
        // background grid
        ctx.globalAlpha = 1;
        ctx.lineWidth = 1;
        ctx.strokeStyle = "#eee";
        for(let k=0;k<5;k++){
          const y = pad + k*(H-pad*2)/4;
          ctx.beginPath(); ctx.moveTo(pad,y); ctx.lineTo(W-pad,y); ctx.stroke();
        }
        for(let k=0;k<5;k++){
          const x = pad + k*(W-pad*2)/4;
          ctx.beginPath(); ctx.moveTo(x,pad); ctx.lineTo(x,H-pad); ctx.stroke();
        }

        // line
        ctx.strokeStyle = "#1f7ae0";
        ctx.lineWidth = 3;
        ctx.beginPath();
        history.forEach((p,i)=>{
          const x = xToPx(i);
          const y = yToPx(p.close);
          if(i===0) ctx.moveTo(x,y);
          else ctx.lineTo(x,y);
        });
        ctx.stroke();
      }

      clear();

      // crosshair + tooltip
      const tip = document.createElement("div");
      tip.style.position="fixed";
      tip.style.pointerEvents="none";
      tip.style.background="#fff";
      tip.style.border="1px solid #e7e7e7";
      tip.style.borderRadius="12px";
      tip.style.padding="8px 10px";
      tip.style.fontSize="13px";
      tip.style.boxShadow="0 10px 20px rgba(0,0,0,.08)";
      tip.style.display="none";
      document.body.appendChild(tip);

      function nearestIndex(px){
        const t = (px - pad) / (W - pad*2);
        const i = Math.round(Math.max(0, Math.min(1, t)) * (history.length-1));
        return i;
      }

      function drawHover(i){
        clear();
        const x = xToPx(i);
        const y = yToPx(history[i].close);

        // crosshair
        ctx.strokeStyle = "rgba(0,0,0,.25)";
        ctx.lineWidth = 1;
        ctx.beginPath(); ctx.moveTo(x,pad); ctx.lineTo(x,H-pad); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(pad,y); ctx.lineTo(W-pad,y); ctx.stroke();

        // marker
        ctx.fillStyle = "#1f7ae0";
        ctx.beginPath(); ctx.arc(x,y,5,0,Math.PI*2); ctx.fill();
        ctx.strokeStyle = "#fff";
        ctx.lineWidth = 2;
        ctx.stroke();
      }

      canvas.addEventListener("mousemove", (e)=>{
        const r = canvas.getBoundingClientRect();
        const mx = e.clientX - r.left;
        const my = e.clientY - r.top;
        if(mx < pad || mx > W-pad || my < pad || my > H-pad){
          tip.style.display="none";
          clear();
          return;
        }
        const i = nearestIndex(mx);
        drawHover(i);

        tip.style.display="block";
        tip.textContent = `${history[i].date}: ${history[i].close.toFixed(1)} DKK`;
        tip.style.left = (e.clientX + 12) + "px";
        tip.style.top  = (e.clientY + 12) + "px";
      });

      canvas.addEventListener("mouseleave", ()=>{
        tip.style.display="none";
        clear();
      });

      window.addEventListener("resize", ()=>{
        tip.style.display="none";
        drawChart(history);
      });
    }

    // -------- boot --------
    async function loadMenuAndTitle(){
      try{
        const r = await fetch(STOCKS_FILE);
        if(!r.ok) throw new Error("HTTP " + r.status);
        const list = await r.json();
        const menu = document.getElementById("stocksMenu");
        menu.innerHTML = "";
        (Array.isArray(list) ? list : []).forEach(s => {
          const a = document.createElement("a");
          a.href = `./stock.html?t=${encodeURIComponent((s.id||"").toLowerCase())}`;
          a.textContent = s.name || s.id;
          menu.appendChild(a);
        });

        const found = (Array.isArray(list) ? list : []).find(x => String(x.id||"").toLowerCase() === id);
        if(found && found.name){
          document.title = found.name;
          document.getElementById("title").textContent = found.name + " (demo)";
        }else{
          document.title = id.toUpperCase();
          document.getElementById("title").textContent = id.toUpperCase() + " (demo)";
        }
      }catch(e){
        console.warn("Kunne ikke hente stocks.json til menu:", e);
      }
    }

    async function loadStock(){
      try{
        const r = await fetch(DATA_FILE);
        if(!r.ok) throw new Error("HTTP " + r.status);
        const d = await r.json();

        document.getElementById("asof").textContent = `Data pr. ${d.asOf || "—"} (ticker: ${d.ticker || id.toUpperCase()})`;

        document.getElementById("close").textContent = (typeof d.close==="number") ? `${fmt(d.close)} DKK` : "—";
        document.getElementById("chg").textContent = (typeof d.changePct==="number") ? fmtPct(d.changePct) : "—";
        document.getElementById("trend").textContent = `${fmt(d.ma20)} / ${fmt(d.ma50)} / ${fmt(d.ma200)}`;
        document.getElementById("vol").textContent = fmt(d.vol20);
        document.getElementById("range").textContent = `${fmt(d.low52w)} – ${fmt(d.high52w)}`;
        const signal = makeSignal(d);
        document.getElementById("signal").textContent = signal;

        const reg = pickRegime(d);
        const mom = pickMomentum(d);
        const risk = pickRisk(d);

        document.getElementById("bRegime").textContent = "Regime: " + reg;
        document.getElementById("bMomentum").textContent = "Momentum: " + mom;
        document.getElementById("bRisk").textContent = "Risiko: " + risk;

        const score = computeScore(d);
        document.getElementById("score").textContent = score;

        const ul = document.getElementById("why");
        ul.innerHTML = "";
        makeWhy(d).forEach(x => {
          const li = document.createElement("li");
          li.textContent = x;
          ul.appendChild(li);
        });

        // chart history
        const hist = Array.isArray(d.history) ? d.history.filter(x => x && typeof x.close==="number" && x.date) : [];
        if(hist.length >= 2){
          drawChart(hist);
        }else{
          setErr("Ingen history i datafilen (tilføj 'history' array for graf).");
        }
      }catch(e){
        setErr(`Fejl: kunne ikke hente/parase datafilen ./data/${id}.json (${e.message})`);
        document.getElementById("asof").textContent = "Kunne ikke indlæse data.";
      }
    }

    loadMenuAndTitle();
    loadStock();
  </script>
</body>
</html>
